<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thai F5-TTS Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .token-chip { display: inline-block; padding: 2px 8px; margin: 2px; background-color: #e0e7ff; color: #3730a3; border-radius: 4px; border: 1px solid #c7d2fe; font-size: 0.9em; }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        
        /* เพิ่มสีพิเศษสำหรับ Auto Split ให้ดูต่างกันนิดหน่อย */
        .toggle-checkbox-orange:checked { right: 0; border-color: #F6AD55; }
        .toggle-checkbox-orange:checked + .toggle-label-orange { background-color: #F6AD55; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen py-8 px-4">

    <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold"><i class="fas fa-wave-square mr-2"></i>Thai F5-TTS Pro</h1>
                <p class="text-indigo-100 text-sm opacity-80">Advanced AI Voice Generator</p>
            </div>
            <div class="flex items-center space-x-2 bg-white/20 p-1 rounded-lg">
                <span class="text-xs font-bold px-2">MODEL:</span>
                <select id="modelVersion" class="bg-white text-indigo-800 text-sm font-bold py-1 px-3 rounded cursor-pointer outline-none hover:bg-gray-50 transition">
                    <option value="v1" selected>Version 1 (Fast)</option>
                    <option value="v2">Version 2 (Better)</option>
                </select>
            </div>
        </div>

        <div class="p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Left Column: Inputs -->
            <div class="lg:col-span-7 space-y-6">
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-2 gap-2">
                        <label class="text-gray-700 font-bold"><i class="far fa-keyboard mr-1"></i> Input Text</label>
                        
                        <!-- Toggle Controls Group -->
                        <div class="flex items-center gap-4">
                            <!-- New: Auto Split Toggle -->
                            <div class="flex items-center" title="ตัดคำอัตโนมัติและเติมเสียงหายใจสำหรับประโยคยาว">
                                <span class="mr-2 text-sm text-gray-600 font-medium"><i class="fas fa-cut text-orange-400 mr-1"></i>Auto Split</span>
                                <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" id="useAutoSplit" class="toggle-checkbox-orange absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 left-0 checked:left-4" />
                                    <label for="useAutoSplit" class="toggle-label-orange block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>

                            <!-- Existing: Auto Normalize Toggle -->
                            <div class="flex items-center">
                                <span class="mr-2 text-sm text-gray-600 font-medium">Normalize</span>
                                <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="toggle" id="useNorm" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 left-0 checked:left-4" checked/>
                                    <label for="useNorm" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <textarea id="inputText" rows="3" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none shadow-inner" placeholder="พิมพ์ข้อความภาษาไทยที่นี่..."></textarea>
                    <div class="flex justify-between items-center mt-2">
                        <span id="charCount" class="text-xs text-gray-400">0 / 300 chars</span>
                        <button onclick="checkNormalize()" class="text-xs bg-indigo-50 text-indigo-600 px-3 py-1 rounded border border-indigo-100 hover:bg-indigo-100 transition"><i class="fas fa-search mr-1"></i> Preview Tokens</button>
                    </div>
                    <div id="normPreview" class="hidden mt-3 p-3 bg-white border border-dashed border-indigo-200 rounded text-sm">
                        <div id="tokenList" class="flex flex-wrap mb-2"></div>
                        <div class="text-xs text-gray-500 border-t pt-2 mt-2"><span class="font-bold">Sent to Model:</span> <span id="finalText" class="text-indigo-700"></span></div>
                    </div>
                </div>

                <!-- Settings -->
                <div class="border rounded-lg overflow-hidden">
                    <div class="bg-gray-100 px-4 py-2 border-b flex justify-between items-center cursor-pointer" onclick="document.getElementById('advSettings').classList.toggle('hidden')">
                        <h3 class="text-gray-700 font-bold text-sm"><i class="fas fa-sliders-h mr-2"></i> Advanced Settings</h3>
                        <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                    </div>
                    <div id="advSettings" class="p-4 bg-white grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Speed</label>
                            <div class="flex items-center"><input type="range" id="speed" min="0.5" max="2.0" step="0.1" value="1.0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mr-2" oninput="document.getElementById('speedVal').innerText = this.value"><span id="speedVal" class="text-sm font-mono w-8 text-center bg-gray-100 rounded">1.0</span></div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Steps</label>
                            <div class="flex items-center"><input type="number" id="step" value="32" min="16" max="100" class="w-full p-1 border rounded text-sm text-center"></div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">CFG Scale</label>
                            <div class="flex items-center"><input type="number" id="cfg" value="2.0" min="0.1" max="10.0" step="0.1" class="w-full p-1 border rounded text-sm text-center"></div>
                        </div>
                    </div>
                </div>

                <!-- Reference -->
                <div class="border-t pt-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Reference Audio</label>
                    <div class="flex items-start space-x-4">
                        <div class="flex-1">
                             <textarea id="refText" rows="2" class="w-full p-2 text-xs border rounded bg-yellow-50 text-gray-600 mb-2">ยินดีต้อนรับ สู่การรถไฟแห่งประเทศไทย  ขบวนรถไฟ กำลังจะเข้าสู่ชานชาลา  โปรดระมัดระวังค่ะ</textarea>
                             <input type="file" id="refAudio" accept=".wav" class="block w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                        </div>
                    </div>
                </div>

                <button id="genBtn" onclick="generateAudio()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transform transition active:scale-95 flex justify-center items-center">
                    <i class="fas fa-play-circle text-xl mr-2"></i> Generate Audio
                </button>
            </div>

            <!-- Right Column: Result -->
            <div class="lg:col-span-5 flex flex-col">
                <div class="bg-white border-2 border-gray-100 rounded-xl h-full shadow-sm flex flex-col items-center justify-center p-6 relative min-h-[400px]">
                    
                    <div id="loading" class="hidden absolute inset-0 bg-white/90 z-10 flex flex-col items-center justify-center rounded-xl">
                        <div class="animate-spin rounded-full h-16 w-16 border-4 border-indigo-200 border-t-indigo-600 mb-4"></div>
                        <p class="text-indigo-800 font-bold animate-pulse">Generating Audio...</p>
                        <p id="loadingMsg" class="text-xs text-gray-500 mt-2">Initializing Model...</p>
                        <p id="timerDisplay" class="text-lg font-mono text-gray-600 mt-2">0.00s</p>
                    </div>

                    <div id="placeholder" class="text-center">
                        <div class="bg-gray-50 rounded-full w-32 h-32 flex items-center justify-center mx-auto mb-4"><i class="fas fa-headphones-alt text-6xl text-gray-300"></i></div>
                        <h3 class="text-gray-400 font-medium">Ready to Generate</h3>
                    </div>

                    

                    <div id="resultArea" class="hidden w-full text-center fade-in">
                        <div class="w-16 h-16 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto text-2xl shadow-sm mb-4"><i class="fas fa-check"></i></div>
                        <h3 class="text-lg font-bold text-gray-800 mb-1">Generated!</h3>
                        
                        <!-- แสดงเวลาที่ใช้ -->
                        <div class="text-sm text-gray-500 mb-3">
                            <span class="bg-gray-100 px-2 py-1 rounded border"><i class="fas fa-stopwatch mr-1"></i> Time: <span id="finalTime" class="font-mono font-bold text-indigo-600">0.00s</span></span>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg mb-4">
                            <audio id="audioPlayer" controls class="w-full h-10"></audio>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <a id="downloadLink" href="#" class="bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded hover:bg-gray-50 transition text-sm flex items-center justify-center">
                                <i class="fas fa-download mr-2"></i> Download
                            </a>
                            <button id="saveBtn" onclick="saveTestResult()" class="bg-green-600 text-white font-bold py-2 px-4 rounded hover:bg-green-700 transition text-sm flex items-center justify-center shadow-md">
                                <i class="fas fa-save mr-2"></i> Save Result
                            </button>
                        </div>
                        <p id="saveStatus" class="text-xs text-gray-400 mt-2 italic"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let lastGenerationTime = 0; 
        let timerInterval = null;
        let lastGeneratedBlob = null; 
        const MAX_CHARS = 300;
        
        document.getElementById('inputText').addEventListener('input', function() {
            const len = this.value.length;
            const counter = document.getElementById('charCount');
            counter.textContent = `${len} / ${MAX_CHARS} chars`;
            counter.classList.toggle('text-red-500', len > MAX_CHARS);
        });

        async function checkNormalize() {
            const text = document.getElementById('inputText').value;
            if(!text) return;
            const formData = new FormData();
            formData.append('text', text);
            try {
                const res = await fetch('/api/normalize', { method: 'POST', body: formData });
                const data = await res.json();
                const container = document.getElementById('tokenList');
                container.innerHTML = '';
                if(data.tokens) data.tokens.forEach(t => container.innerHTML += `<span class="token-chip">${t}</span>`);
                document.getElementById('finalText').textContent = data.normalized;
                document.getElementById('normPreview').classList.remove('hidden');
            } catch(e) { console.error(e); }
        }
        
        async function generateAudio() {
            const text = document.getElementById('inputText').value;
            if (!text) { alert("กรุณาใส่ข้อความ"); return; }
            if (text.length > MAX_CHARS && !confirm("ข้อความยาวเกินไป ยืนยันทำต่อ?")) return;

            // --- RESET UI ---
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Save Result';
            document.getElementById('saveStatus').innerText = ""; 
            
            document.getElementById('genBtn').disabled = true;
            document.getElementById('genBtn').classList.add('opacity-50');
            document.getElementById('placeholder').classList.add('hidden');
            document.getElementById('resultArea').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');

            // --- START TIMER ---
            const startTime = performance.now();
            const timerDisplay = document.getElementById('timerDisplay');
            timerDisplay.innerText = "0.00s";
            
            // ทำให้ตัวเลขเวลาวิ่งๆ ให้ User รู้ว่าไม่ค้าง
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const current = (performance.now() - startTime) / 1000;
                timerDisplay.innerText = current.toFixed(2) + "s";
            }, 100);

            const formData = new FormData();
            formData.append('text', text);
            formData.append('ref_text', document.getElementById('refText').value);
            formData.append('model_version', document.getElementById('modelVersion').value);
            formData.append('use_norm', document.getElementById('useNorm').checked);
            formData.append('use_auto_split', document.getElementById('useAutoSplit').checked);
            formData.append('speed', document.getElementById('speed').value);
            formData.append('step', document.getElementById('step').value);
            formData.append('cfg', document.getElementById('cfg').value);
            if(document.getElementById('refAudio').files[0]) formData.append('ref_audio', document.getElementById('refAudio').files[0]);

            try {
                const res = await fetch('/api/generate', { method: 'POST', body: formData });
                if (!res.ok) throw new Error(await res.text());

                const blob = await res.blob();
                lastGeneratedBlob = blob; 

                // --- STOP TIMER ---
                clearInterval(timerInterval);
                const endTime = performance.now();
                lastGenerationTime = (endTime - startTime) / 1000; // แปลงเป็นวินาที

                // Update UI with Time
                document.getElementById('finalTime').innerText = lastGenerationTime.toFixed(2) + "s";

                const url = URL.createObjectURL(blob);
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.src = url;
                document.getElementById('downloadLink').href = url;
                document.getElementById('downloadLink').download = `tts_gen_${Date.now()}.wav`;

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('resultArea').classList.remove('hidden');
                audioPlayer.play();
            } catch (err) {
                clearInterval(timerInterval);
                alert("Error: " + err.message);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('placeholder').classList.remove('hidden');
            } finally {
                document.getElementById('genBtn').disabled = false;
                document.getElementById('genBtn').classList.remove('opacity-50');
            }
        }

        async function saveTestResult() {
            if (!lastGeneratedBlob) return;
            
            const btn = document.getElementById('saveBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';
            btn.disabled = true;

            const formData = new FormData();
            formData.append('audio', lastGeneratedBlob, "result.wav"); 
            formData.append('text', document.getElementById('inputText').value);
            formData.append('model_version', document.getElementById('modelVersion').value);
            formData.append('speed', document.getElementById('speed').value);
            formData.append('step', document.getElementById('step').value);
            formData.append('cfg', document.getElementById('cfg').value);
            formData.append('gen_time', lastGenerationTime);

            try {
                const res = await fetch('/api/save_result', { method: 'POST', body: formData });
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                
                document.getElementById('saveStatus').innerHTML = `<span class="text-green-600"><i class="fas fa-check-circle"></i> Saved as ${data.filename}</span>`;
                btn.innerHTML = '<i class="fas fa-check mr-2"></i> Saved';
            } catch (err) {
                alert("Save Error: " + err.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>